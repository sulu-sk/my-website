<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Context Flow - Learn English</title>
    
    <!-- Fonts: Nunito -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons: FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Nunito', 'sans-serif'],
                },
                extend: {
                    colors: {
                        brand: {
                            light: '#e0c3fc',
                            dark: '#8ec5fc',
                            primary: '#6366f1',
                            success: '#10b981',
                            error: '#ef4444'
                        }
                    },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbar */
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        *::-webkit-scrollbar {
            display: none;
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100%;
            background: #f8fafc;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 481px) {
            .app-container {
                height: 95vh;
                margin-top: 2.5vh;
                border-radius: 24px;
            }
        }

        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .screen.active {
            opacity: 1;
        }

        .btn-option {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        
        .btn-option:active {
            transform: scale(0.98);
        }

        #bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header (Global) -->
        <header id="app-header" class="glass-header sticky top-0 z-20 px-6 py-4 flex justify-between items-center transition-all duration-300">
            <div class="flex items-center space-x-2 text-orange-500">
                <i class="fa-solid fa-fire text-xl animate-pulse-slow"></i>
                <span id="streak-display" class="font-bold text-lg">0</span>
            </div>
            <div class="flex items-center space-x-2 text-indigo-600">
                <i class="fa-solid fa-star text-lg"></i>
                <span id="xp-display" class="font-bold text-lg">0 XP</span>
            </div>
        </header>

        <!-- SCREEN: HOME -->
        <div id="screen-home" class="screen active flex">
            <div class="mt-4 mb-8">
                <h1 class="text-3xl font-extrabold text-gray-800 mb-1">–ü—Ä–∏–≤–µ—Ç! üëã</h1>
                <p class="text-gray-500 text-sm">–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å. –í—ã–±–µ—Ä–∏ —Ç–µ–º—É:</p>
            </div>

            <!-- Daily Goal Card -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-8 transform transition hover:scale-[1.02]">
                <div class="flex justify-between items-end mb-2">
                    <span class="font-bold text-gray-700">–¶–µ–ª—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</span>
                    <span class="text-xs text-indigo-500 font-bold" id="daily-progress-text">0/100 XP</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                    <div id="daily-progress-bar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
            </div>

            <!-- Categories Grid -->
            <h2 class="text-lg font-bold text-gray-800 mb-4">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            <div class="grid grid-cols-1 gap-3 pb-8">
                
                <!-- Category 1: Basics -->
                <div onclick="app.startGame('basics')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-blue-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center text-xl mr-4 group-hover:bg-blue-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-shapes"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–ë–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–û—Å–Ω–æ–≤—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –∏ —Ñ—Ä–∞–∑</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-blue-50 group-hover:text-blue-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>

                <!-- Category 2: Business -->
                <div onclick="app.startGame('business')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-purple-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-purple-50 text-purple-500 flex items-center justify-center text-xl mr-4 group-hover:bg-purple-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-briefcase"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–ë–∏–∑–Ω–µ—Å</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–î–ª—è —Ä–∞–±–æ—Ç—ã –∏ –∫–∞—Ä—å–µ—Ä—ã</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-purple-50 group-hover:text-purple-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>

                <!-- Category 3: Travel -->
                <div onclick="app.startGame('travel')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-teal-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-teal-50 text-teal-500 flex items-center justify-center text-xl mr-4 group-hover:bg-teal-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-plane-up"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–ê—ç—Ä–æ–ø–æ—Ä—Ç, –æ—Ç–µ–ª—å, –≥–æ—Ä–æ–¥</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-teal-50 group-hover:text-teal-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>

                <!-- Category 4: Food -->
                <div onclick="app.startGame('food')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-orange-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-orange-50 text-orange-500 flex items-center justify-center text-xl mr-4 group-hover:bg-orange-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-utensils"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–ï–¥–∞</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∑–∞–∫–∞–∑ –µ–¥—ã</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-orange-50 group-hover:text-orange-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>

                <!-- Category 5: Hobbies -->
                <div onclick="app.startGame('hobbies')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-pink-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-pink-50 text-pink-500 flex items-center justify-center text-xl mr-4 group-hover:bg-pink-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-guitar"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–•–æ–±–±–∏</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–°–ø–æ—Ä—Ç, –º—É–∑—ã–∫–∞, –æ—Ç–¥—ã—Ö</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-pink-50 group-hover:text-pink-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>

                <!-- Category 6: Tech -->
                <div onclick="app.startGame('tech')" class="cursor-pointer bg-white rounded-2xl p-4 shadow-sm border border-gray-100 hover:border-indigo-200 hover:shadow-md transition-all active:scale-95 flex items-center group">
                    <div class="w-14 h-14 rounded-xl bg-indigo-50 text-indigo-500 flex items-center justify-center text-xl mr-4 group-hover:bg-indigo-500 group-hover:text-white transition-colors duration-300">
                        <i class="fa-solid fa-microchip"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg text-gray-800">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h3>
                        <p class="text-gray-400 text-xs mt-0.5">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –≥–∞–¥–∂–µ—Ç—ã</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 flex items-center justify-center group-hover:bg-indigo-50 group-hover:text-indigo-400 transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- SCREEN: GAME -->
        <div id="screen-game" class="screen relative hidden">
            <!-- Game Top Bar -->
            <div class="flex justify-between items-center mb-8">
                <button onclick="app.quitGame()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center transition">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="w-full bg-gray-200 rounded-full h-2 mx-4 bg-gray-200 overflow-hidden">
                    <div id="game-progress" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <button onclick="app.toggleSound()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 flex items-center justify-center transition focus:outline-none">
                    <i id="sound-icon" class="fa-solid fa-volume-high"></i>
                </button>
            </div>

            <!-- Question Area -->
            <div class="flex-1 flex flex-col justify-center items-center mb-8">
                <div id="sentence-container" class="text-2xl md:text-3xl font-bold text-gray-800 text-center leading-relaxed">
                    <!-- Injected via JS -->
                </div>
                <p id="sentence-translation" class="text-gray-400 mt-4 text-sm font-medium text-center opacity-0 transition-opacity duration-300 h-6">
                    <!-- Translation injected via JS -->
                </p>
            </div>

            <!-- Options Grid -->
            <div id="options-container" class="grid grid-cols-1 gap-3 mb-20">
                <!-- Buttons injected via JS -->
            </div>
        </div>

        <!-- BOTTOM SHEET (Feedback) -->
        <div id="bottom-sheet" class="absolute bottom-0 left-0 w-full rounded-t-3xl p-6 transform translate-y-full z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
            <div class="flex items-start mb-4">
                <div id="sheet-icon-container" class="w-12 h-12 rounded-full flex items-center justify-center mr-4 text-2xl bg-white shadow-sm">
                    <i id="sheet-icon" class="fa-solid fa-check"></i>
                </div>
                <div>
                    <h3 id="sheet-title" class="text-xl font-bold mb-1">–û—Ç–ª–∏—á–Ω–æ!</h3>
                    <p id="sheet-message" class="text-sm opacity-90">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.</p>
                </div>
            </div>
            <button id="next-btn" class="w-full py-4 rounded-xl font-bold text-white shadow-md uppercase tracking-wide transition transform active:scale-95 text-lg">
                –î–∞–ª—å—à–µ <span class="ml-2 bg-white/20 px-2 py-0.5 rounded text-xs opacity-70">Enter</span>
            </button>
        </div>

        <!-- SCREEN: RESULT -->
        <div id="screen-result" class="screen flex flex-col items-center justify-center hidden">
            <div class="mb-6 relative">
                <div class="absolute inset-0 bg-yellow-200 rounded-full opacity-20 animate-ping"></div>
                <i class="fa-solid fa-trophy text-6xl text-yellow-500 relative z-10 animate-pop"></i>
            </div>
            
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2">–£—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω!</h2>
            <p class="text-gray-500 mb-8">–í–æ—Ç —Ç–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>

            <div class="grid grid-cols-2 gap-4 w-full mb-8">
                <div class="bg-indigo-50 rounded-2xl p-4 text-center">
                    <span class="block text-indigo-500 text-xs font-bold uppercase mb-1">XP –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                    <span id="result-xp" class="text-3xl font-extrabold text-indigo-700">0</span>
                </div>
                <div class="bg-green-50 rounded-2xl p-4 text-center">
                    <span class="block text-green-500 text-xs font-bold uppercase mb-1">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</span>
                    <span id="result-correct" class="text-3xl font-extrabold text-green-700">0/5</span>
                </div>
            </div>

            <button onclick="app.showHome()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </div>

    </div>

    <script>
        /**
         * Sound Controller - Uses Web Audio API
         */
        const SoundController = {
            ctx: null,
            
            init() {
                // Initialize audio context on first user interaction to bypass browser policies
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
            },

            playTone(freq, type, duration, vol = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },

            playSuccess() {
                if (!app.state.soundEnabled) return;
                this.init();
                // Play a "Ding" - two sine waves
                setTimeout(() => this.playTone(523.25, 'sine', 0.6, 0.1), 0); // C5
                setTimeout(() => this.playTone(659.25, 'sine', 0.6, 0.1), 100); // E5
            },

            playError() {
                if (!app.state.soundEnabled) return;
                this.init();
                // Play a "Buzz" - low saw wave
                this.playTone(150, 'sawtooth', 0.4, 0.05);
            },

            playClick() {
                if (!app.state.soundEnabled) return;
                this.init();
                // Short high blip
                this.playTone(800, 'sine', 0.05, 0.02);
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            // State
            state: {
                totalXP: 0,
                streak: 0,
                dailyXP: 0,
                lastPlayedDate: null,
                soundEnabled: true,
                currentCategory: null,
                queue: [],
                currentQuestionIndex: 0,
                roundScore: 0,
                totalQuestions: 5,
                isAnswered: false,
                dailyGoal: 100
            },

            // Init
            init() {
                this.loadProgress();
                this.checkDailyReset();
                this.updateUI();
                this.setupEventListeners();
                
                // Show Home screen initially
                this.showScreen('screen-home');
            },

            // Data Persistence
            loadProgress() {
                const savedData = localStorage.getItem('contextFlow_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    this.state.totalXP = parsed.totalXP || 0;
                    this.state.streak = parsed.streak || 0;
                    this.state.dailyXP = parsed.dailyXP || 0;
                    this.state.lastPlayedDate = parsed.lastPlayedDate;
                }
            },

            saveProgress() {
                const data = {
                    totalXP: this.state.totalXP,
                    streak: this.state.streak,
                    dailyXP: this.state.dailyXP,
                    lastPlayedDate: this.state.lastPlayedDate
                };
                localStorage.setItem('contextFlow_data', JSON.stringify(data));
            },

            checkDailyReset() {
                const today = new Date().toDateString();
                if (this.state.lastPlayedDate !== today) {
                    // New day, reset daily XP
                    this.state.dailyXP = 0;
                    this.state.lastPlayedDate = today;
                    this.saveProgress();
                }
            },

            // Navigation
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(el => {
                    el.classList.remove('active', 'flex', 'hidden');
                    if (el.id === screenId) {
                        el.classList.add('flex', 'active');
                    } else {
                        el.classList.add('hidden');
                    }
                });

                // Toggle header visibility
                const header = document.getElementById('app-header');
                if (screenId === 'screen-result') {
                    header.classList.add('-translate-y-full');
                } else {
                    header.classList.remove('-translate-y-full');
                }
            },

            // Game Logic
async startGame(category) {
    // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    SoundController.init();
    SoundController.playClick();
    
    this.state.currentCategory = category;
    this.state.currentQuestionIndex = 0;
    this.state.roundScore = 0;
    this.state.isAnswered = false;

    try {
        // 2. –ó–ê–ì–†–£–ñ–ê–ï–ú –§–ê–ô–õ –° –í–û–ü–†–û–°–ê–ú–ò
        // –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å –≤ –ø–∞–ø–∫–µ data/–∏–º—è_–∫–∞—Ç–µ–≥–æ—Ä–∏–∏.json
        const response = await fetch(`data/${category}.json`);
        
        if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã');
        
        const catQuestions = await response.json();

        // 3. –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã (Fisher-Yates shuffle)
        this.state.queue = catQuestions.sort(() => 0.5 - Math.random()).slice(0, this.state.totalQuestions);

        // –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –º–∞–ª–æ, –º–æ–∂–Ω–æ –Ω–µ –æ–±—Ä–µ–∑–∞—Ç—å slice'–æ–º, –∞ –±—Ä–∞—Ç—å –≤—Å–µ
        
        this.showScreen('screen-game');
        this.renderQuestion();
        this.updateProgressBar();

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
        alert("–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.");
    }
},

            renderQuestion() {
                const q = this.state.queue[this.state.currentQuestionIndex];
                const container = document.getElementById('sentence-container');
                const translation = document.getElementById('sentence-translation');
                const optionsContainer = document.getElementById('options-container');

                // Reset UI state
                this.state.isAnswered = false;
                this.closeBottomSheet();
                translation.classList.add('opacity-0');

                // Render Sentence
                container.innerHTML = `
                    ${q.pre} 
                    <span id="target-gap" class="border-b-4 border-dashed border-indigo-300 text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-indigo-600 px-1 mx-1 min-w-[80px] inline-block transition-all">______</span> 
                    ${q.post}
                `;

                translation.textContent = q.translation;

                // Render Options
                optionsContainer.innerHTML = '';
                q.options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    btn.className = `btn-option w-full bg-white border-2 border-gray-100 text-gray-700 py-4 rounded-xl font-bold text-lg shadow-sm hover:border-indigo-100 relative overflow-hidden`;
                    
                    // Add keyboard hint
                    const keyHint = document.createElement('span');
                    keyHint.className = "absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-300 text-xs font-mono border border-gray-200 px-1.5 py-0.5 rounded hidden md:block";
                    keyHint.textContent = index + 1;
                    
                    btn.appendChild(keyHint);
                    btn.appendChild(document.createTextNode(opt));
                    
                    btn.onclick = () => this.handleAnswer(index, btn);
                    btn.dataset.index = index;
                    optionsContainer.appendChild(btn);
                });
            },

            handleAnswer(selectedIndex, btnElement) {
                if (this.state.isAnswered) return;
                this.state.isAnswered = true;

                const q = this.state.queue[this.state.currentQuestionIndex];
                const isCorrect = selectedIndex === q.correctIndex;
                const gapElement = document.getElementById('target-gap');

                // UI Updates
                const allBtns = document.querySelectorAll('.btn-option');
                
                if (isCorrect) {
                    // Correct Logic
                    this.state.roundScore++;
                    btnElement.classList.remove('border-gray-100', 'bg-white');
                    btnElement.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    
                    // Gap Fill
                    gapElement.textContent = q.target;
                    gapElement.classList.remove('border-dashed', 'text-transparent', 'border-indigo-300');
                    gapElement.classList.add('text-green-600', 'border-b-0', 'animate-pulse');

                    SoundController.playSuccess();
                    this.speak(`${q.pre} ${q.target} ${q.post}`);
                    
                    this.showBottomSheet(true, "–û—Ç–ª–∏—á–Ω–æ!", "–¢—ã —É–ª–æ–≤–∏–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç!");
                } else {
                    // Incorrect Logic
                    btnElement.classList.add('bg-red-100', 'border-red-400', 'text-red-700', 'animate-shake');
                    
                    // Highlight correct answer
                    allBtns[q.correctIndex].classList.add('bg-green-50', 'border-green-200', 'text-green-700');
                    
                    gapElement.textContent = q.target;
                    gapElement.classList.remove('border-dashed', 'text-transparent', 'border-indigo-300');
                    gapElement.classList.add('text-red-500', 'border-b-0');

                    SoundController.playError();
                    this.showBottomSheet(false, "–û—à–∏–±–æ—á–∫–∞...", `–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: "${q.target}"`);
                }

                // Show translation
                document.getElementById('sentence-translation').classList.remove('opacity-0');
            },

            nextQuestion() {
                SoundController.playClick();
                this.state.currentQuestionIndex++;
                
                if (this.state.currentQuestionIndex >= this.state.totalQuestions) {
                    this.finishGame();
                } else {
                    this.updateProgressBar();
                    this.renderQuestion();
                }
            },

            updateProgressBar() {
                const pct = (this.state.currentQuestionIndex / this.state.totalQuestions) * 100;
                document.getElementById('game-progress').style.width = `${pct}%`;
            },

            finishGame() {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                this.closeBottomSheet();

                // Calculate rewards
                const xpGained = this.state.roundScore * 10;
                this.state.totalXP += xpGained;
                this.state.dailyXP += xpGained;
                this.state.streak += 1;
                
                this.saveProgress();
                this.updateUI();

                // Setup Result Screen
                SoundController.playSuccess();
                document.getElementById('result-xp').textContent = `+${xpGained}`;
                document.getElementById('result-correct').textContent = `${this.state.roundScore}/${this.state.totalQuestions}`;
                
                this.showScreen('screen-result');
            },

            quitGame() {
                if (confirm("–í—ã–π—Ç–∏ –∏–∑ —É—Ä–æ–∫–∞? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.")) {
                    SoundController.playClick();
                    this.closeBottomSheet(); // –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
                    this.showHome();
                }
            },

            showHome() {
                SoundController.playClick();
                this.showScreen('screen-home');
                this.updateUI();
            },

            // UI Components
            showBottomSheet(isSuccess, title, msg) {
                const sheet = document.getElementById('bottom-sheet');
                const sheetIconContainer = document.getElementById('sheet-icon-container');
                const sheetIcon = document.getElementById('sheet-icon');
                const btn = document.getElementById('next-btn');

                // Colors
                if (isSuccess) {
                    sheet.className = "absolute bottom-0 left-0 w-full rounded-t-3xl p-6 transform z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] bg-green-50 text-green-900 translate-y-0";
                    sheetIconContainer.className = "w-12 h-12 rounded-full flex items-center justify-center mr-4 text-2xl bg-white text-green-500 shadow-sm";
                    sheetIcon.className = "fa-solid fa-check";
                    btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md uppercase tracking-wide transition transform active:scale-95 text-lg bg-green-500 hover:bg-green-600";
                } else {
                    sheet.className = "absolute bottom-0 left-0 w-full rounded-t-3xl p-6 transform z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] bg-red-50 text-red-900 translate-y-0";
                    sheetIconContainer.className = "w-12 h-12 rounded-full flex items-center justify-center mr-4 text-2xl bg-white text-red-500 shadow-sm";
                    sheetIcon.className = "fa-solid fa-xmark";
                    btn.className = "w-full py-4 rounded-xl font-bold text-white shadow-md uppercase tracking-wide transition transform active:scale-95 text-lg bg-red-500 hover:bg-red-600";
                }

                document.getElementById('sheet-title').textContent = title;
                document.getElementById('sheet-message').textContent = msg;

                // Setup next button
                btn.onclick = () => this.nextQuestion();
            },

            closeBottomSheet() {
                const sheet = document.getElementById('bottom-sheet');
                sheet.classList.add('translate-y-full');
                sheet.classList.remove('translate-y-0');
            },

            updateUI() {
                document.getElementById('xp-display').textContent = `${this.state.totalXP} XP`;
                document.getElementById('streak-display').textContent = this.state.streak;

                // Daily Goal Logic
                let dailyProgress = Math.min(100, (this.state.dailyXP / this.state.dailyGoal) * 100);
                
                document.getElementById('daily-progress-bar').style.width = `${dailyProgress}%`;
                
                // Color change on completion
                if (this.state.dailyXP >= this.state.dailyGoal) {
                    document.getElementById('daily-progress-bar').classList.remove('bg-indigo-500');
                    document.getElementById('daily-progress-bar').classList.add('bg-green-500');
                    document.getElementById('daily-progress-text').classList.add('text-green-600');
                    document.getElementById('daily-progress-text').textContent = "–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!";
                } else {
                    document.getElementById('daily-progress-bar').classList.add('bg-indigo-500');
                    document.getElementById('daily-progress-bar').classList.remove('bg-green-500');
                    document.getElementById('daily-progress-text').classList.remove('text-green-600');
                    document.getElementById('daily-progress-text').textContent = `${this.state.dailyXP}/${this.state.dailyGoal} XP`;
                }
            },

            toggleSound() {
                this.state.soundEnabled = !this.state.soundEnabled;
                SoundController.playClick();
                const icon = document.getElementById('sound-icon');
                if (this.state.soundEnabled) {
                    icon.className = "fa-solid fa-volume-high";
                } else {
                    icon.className = "fa-solid fa-volume-xmark";
                }
            },

            speak(text) {
                if (!this.state.soundEnabled || !('speechSynthesis' in window)) return;
                
                // Cancel previous
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;

                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google US English') || v.name.includes('Samantha'));
                if (preferredVoice) utterance.voice = preferredVoice;

                window.speechSynthesis.speak(utterance);
            },

            setupEventListeners() {
                // Keyboard Support
                document.addEventListener('keydown', (e) => {
                    if (document.getElementById('screen-game').classList.contains('hidden')) return;

                    const key = e.key;
                    
                    // If Sheet is open, Enter = Next
                    const sheetOpen = !document.getElementById('bottom-sheet').classList.contains('translate-y-full');
                    
                    if (sheetOpen && key === 'Enter') {
                        this.nextQuestion();
                        return;
                    }

                    // If Sheet is closed, Numbers = Answer
                    if (!this.state.isAnswered && !sheetOpen) {
                        const btns = document.querySelectorAll('#options-container button');
                        if (key === '1' && btns[0]) this.handleAnswer(0, btns[0]);
                        if (key === '2' && btns[1]) this.handleAnswer(1, btns[1]);
                        if (key === '3' && btns[2]) this.handleAnswer(2, btns[2]);
                        if (key === '4' && btns[3]) this.handleAnswer(3, btns[3]);
                    }
                });
            }
        };

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            // Preload voices
            window.speechSynthesis.getVoices();
        });

    </script>
</body>
</html>